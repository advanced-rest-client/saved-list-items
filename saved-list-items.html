<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-dropdown/iron-dropdown.html">
<link rel="import" href="../paper-styles/shadow.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../paper-input/paper-input.html">
<!--
A `<saved-list-items>` element renders a list of fistory items.

It should be used in a ARC requests saved list view.

## Example
```
<saved-list-items id="saved" items="[[list]]"></saved-list-items>
```
The `list` attribute is a list of requests to display.
The `list` will not change from the inside of the element and every state
change is informed via events.

It is safe to load a lot of results into the list. This element uses
the `iron-list` element that renders only a potion of items only to fit
available space.

## Adding pagination
Simplest solution is just to override the `items` array with new values.
It will cause list reset though and it will jump to fisrt element.
To avoid it you can use element's `addItems` function.
However the element will not notify back change in the list so other elements
or app will not notice element's array change.

To avoid this update the array of items as follows:
```
const newItems = new Array(100);
newItems.forEach((i) => this.push('existingItems', i));
```
It will push new elements - one by one - to the end of the array and notify
paths each time the new element will be added.

### Styling
`<history-list-items>` provides the following custom properties and mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--saved-list-items` | Mixin applied to each list item | `{}`
`--saved-list-items-url` | Mixin applied to the URL display element. Note that it is a inline element. | `{}`
`--saved-list-items-method` | Mixin applied to the method display element. Note that it is a inline element. | `{}`
`--saved-list-items-height` | Height of the list item. | `60px`
`--saved-list-items-background-color` | Background color of the list. | `transparent`
`--saved-list-items-selected-background-color` | Selection color for list items. | `#E0E0E0`
`--saved-list-items-meta-row-color` | Font color of the bottom "meta" row (the one with time information.) | `#757575`
`--saved-list-items-meta-row-font-size` | Font size of the bottom "meta" row (the one with time information.) | `12px`
`--saved-list-items-open-background-color` | Background color of the "open" button. | `#1E88E5`
`--saved-list-items-open-color` | Font color of the "open" button. | `white`

You can style checkbox with paper-checkbox styles like:
```
:host {
  --paper-checkbox-checked-color: #1E88E5;
}
```

@group UI Elements
@element saved-list-items
@demo demo/index.html
-->
<dom-module id="saved-list-items">
  <template>
    <style>
     :host {
      display: block;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .saved-item {
      @apply(--layout-horizontal);
      @apply(--layout-center);
      @apply(--paper-font-body1);
      font-size: 14px;
      height: var(--saved-list-items-height, 60px);
      background-color: var(--saved-list-items-background-color, transparent);
      @apply(--saved-list-items);
    }

    .saved-item.selected {
      background-color: var(--saved-list-items-selected-background-color, #E0E0E0);
    }

    .checkbox-column {
      @apply(--layout);
      @apply(--layout-center-center);
      height: 48px;
      width: 48px;
    }

    .name-column {
      @apply(--layout-flex);
      position: relative;
    }

    .data-column {
      @apply(--layout-vertical);
      @apply(--layout-flex-3);
      @apply(--paper-font-common-nowrap);
      @apply(--saved-list-item-name-column);
    }

    .url-method-row {
      @apply(--layout-horizontal);
    }

    .method {
      margin-right: 8px;
    }

    .url {
      @apply(--layout-flex);
      @apply(--paper-font-common-nowrap);
      @apply(--saved-list-item-url);
    }

    .meta-row {
      color: var(--saved-list-items-meta-row-color, #757575);
      font-size: var(--saved-list-items-meta-row-font-size, 12px);
    }

    .action-column {
      @apply(--layout-horizontal);
    }

    .open-action {
      background-color: var(--saved-list-items-open-background-color, #1E88E5);
      color: var(--saved-list-items-open-color, white);
    }

    .name-change-popover {
      background-color: white;
      padding: 16px;
      @apply(--shadow-elevation-4dp);
    }

    iron-list {
      flex: 1 1 auto;
    }
    </style>
    <iron-list id="list" items="[[items]]" selected-items="{{selectedItems}}" multi-selection selection-enabled>
      <template>
        <div class$="[[_computeRowClass(selected)]]" tabindex$="[[tabIndex]]" aria-label$="Select/Deselect [[item.url]]">
          <div class="checkbox-column">
            <paper-checkbox checked="{{selected}}"></paper-checkbox>
          </div>
          <div class="name-column" title$="[[item.name]]">
            <span on-tap="_editName">[[item.name]]</span>
          </div>
          <div class="data-column">
            <div class="url-method-row">
              <span class="method">[[item.method]]</span>
              <span class="url" title$="[[item.url]]">[[item.url]]</span>
            </div>
            <div class="meta-row">
              <span class="time">[[_computeTime(item.created)]]</span>
            </div>
          </div>
          <div class="action-column">
            <paper-button on-tap="_deleteItem">delete</paper-button>
            <paper-button class="open-action" on-tap="_navigateItem">open</paper-button>
          </div>
        </div>
      </template>
    </iron-list>
    <iron-scroll-threshold id="scrollTheshold" lower-threshold="[[threshold]]" on-lower-threshold="_thresholdReached" scroll-target="list"></iron-scroll-threshold>
    <iron-dropdown id="nameChange" always-on-top focus-target="[[_nameInput]]" on-iron-overlay-closed="_nameEditorClosed">
      <div class="dropdown-content name-change-popover">
        <paper-input label="Request name" id="nameChangeInput" on-keydown="_nameKeyDown"></paper-input>
      </div>
    </iron-dropdown>
  </template>
  <script>
  Polymer({
    is: 'saved-list-items',
    /**
     * Fired when the user clicked on a delete button on an item.
     *
     * @event saved-list-item-delete
     * @param {Object} item An object associated with this item.
     * @param {Number} index Object's index in the list.
     */
    /**
     * Fired when the user clicked on an open button on an item.
     *
     * @event saved-list-item-open
     * @param {Object} item An object associated with this item.
     * @param {Number} index Object's index in the list.
     */
    /**
     * Fired when the user nearly scrolled to the ened of the list.
     * It usually means that the app should load more results.
     *
     * @event saved-list-threshold
     */
    /**
     * Fired when the name of an item has changed.
     * Handler is responsible for updating the state of the list outside
     * this element (since changes are not propagated outside this element)
     * and for storing relevant data to the datastore.
     *
     * @event saved-list-item-name-changed
     * @param {Object} item An object associated with this item.
     * @param {Number} index Object's index in the list.
     * @param {String} value New value of the name.
     */
    properties: {
      // The list of saved items to render.
      items: Array,
      // List of selected items on the list.
      selectedItems: {
        type: Array,
        notify: true
      },
      /**
       * A list lower treshold when the `saved-list-threshold` will be
       * fired. It should informa the app that the user nearly reached
       * the end of the list and new items should be loaded.
       */
      threshold: {
        type: Number,
        value: 80
      },
      /**
       * If true, the user selected some elements on list. Check the
       * `this.selectedItems` property to check for the selected elements.
       */
      hasSelection: {
        type: Boolean,
        value: false,
        computed: '_computeHasSelection(selectedItems.length)'
      },

      _nameInput: {
        type: HTMLElement,
        value: function() {
          return this.$.nameChangeInput;
        }
      }
    },

    observers: [
      '_sizeChanged(items.length)'
    ],

    hostAttributes: {
      'role': 'list'
    },

    _sizeChanged: function(length) {
      if (length) {
        this.async(() => {
          this.$.scrollTheshold.clearTriggers();
        }, 1);
      }
    },

    _computeTime: function(timestamp) {
      var d = new Date(timestamp);
      var options = {
        year: 'numeric',
        month: 'numeric',
        day: 'numeric',
        hour: 'numeric',
        minute: 'numeric',
        second: 'numeric'
      };
      return new Intl.DateTimeFormat(undefined, options).format(d);
    },

    _computeRowClass: function(selected) {
      var clazz = 'saved-item';
      if (selected) {
        clazz += ' selected';
      }
      return clazz;
    },

    _deleteItem: function(e) {
      this.fire('saved-list-item-delete', {
        item: e.model.get('item'),
        index: e.model.get('index')
      });
    },

    _navigateItem: function(e) {
      this.fire('saved-list-item-open', {
        item: e.model.get('item'),
        index: e.model.get('index')
      });
    },

    _thresholdReached: function() {
      this.fire('saved-list-threshold');
    },

    _computeHasSelection: function(length) {
      return !!length;
    },

    _editName: function(e) {
      e.preventDefault();
      e.stopPropagation();
      var name = e.model.get('item.name');
      this.currentEditredModel = e.model;
      this.$.nameChangeInput.value = name;

      e = Polymer.dom(e);
      this.$.nameChange.positionTarget = e.localTarget.parentElement ||
        e.localTarget;
      this.$.nameChange.opened = true;
    },

    _nameKeyDown: function(e) {
      if (e.keyCode !== 13) {
        return;
      }
      var model = this.currentEditredModel;
      var value = this.$.nameChangeInput.value;
      model.set('item.name', value);
      this.fire('saved-list-item-name-changed', {
        item: model.get('item'),
        index: model.get('index'),
        value: value
      });
      this.$.nameChange.opened = false;
    },

    _nameEditorClosed: function() {
      this.currentEditredModel = null;
      this.$.nameChangeInput.value = '';
    },
    /**
     * Use this method to add new items to the `items` array.
     * It will prohibit list jumping while changing the list object manually
     *
     * @param {Array} items List of items to add.
     */
    addItems: function(items) {
      if (!items || !items.length) {
        return;
      }
      items.forEach((i) => this.push('items', i));
    }
  });
  </script>
</dom-module>
